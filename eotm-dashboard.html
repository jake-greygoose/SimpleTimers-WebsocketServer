<!DOCTYPE html>
<html lang="en" data-theme="night">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EOTM Assist Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
  <style>
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 p-3 sm:p-6">
  <div class="max-w-6xl mx-auto">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold">EOTM Assist Dashboard</h1>
        <p class="text-sm text-gray-400">Live status and control panel</p>
      </div>
      <div class="flex items-center gap-2">
        <span id="connection-status" class="badge badge-error">Disconnected</span>
        <button id="reconnect-btn" class="btn btn-sm btn-primary">Reconnect</button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
      <div class="card bg-gray-800 p-4">
        <div class="text-sm text-gray-400">Total Clients</div>
        <div id="total-clients" class="text-3xl font-bold">0</div>
      </div>
      <div class="card bg-gray-800 p-4">
        <div class="text-sm text-gray-400">Active Instances</div>
        <div id="total-instances" class="text-3xl font-bold">0</div>
      </div>
      <div class="card bg-gray-800 p-4">
        <div class="text-sm text-gray-400">Active Machines</div>
        <div id="total-machines" class="text-3xl font-bold">0</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
      <div class="card bg-gray-800 p-4">
        <h2 class="text-lg font-semibold mb-3">Bulk Actions</h2>
        <div class="flex flex-col gap-3">
          <div class="flex gap-2">
            <input id="close-excess-count" type="number" min="0" value="2" class="input input-bordered flex-1 bg-gray-700" placeholder="Keep per instance">
            <button id="close-excess-btn" class="btn btn-warning">Close Excess</button>
          </div>
          <div class="flex gap-2">
            <input id="keep-per-machine-count" type="number" min="0" value="5" class="input input-bordered flex-1 bg-gray-700" placeholder="Keep per machine">
            <button id="keep-per-machine-btn" class="btn btn-warning">Keep Per Machine</button>
          </div>
          <div class="flex gap-2">
            <input id="set-fps-value" type="number" min="1" max="200" value="15" class="input input-bordered flex-1 bg-gray-700" placeholder="FPS">
            <button id="set-fps-btn" class="btn btn-info">Set FPS All</button>
          </div>
          <div class="flex gap-2">
            <button id="minimize-all-btn" class="btn btn-secondary flex-1">Minimize All</button>
            <button id="focus-all-btn" class="btn btn-secondary flex-1">Focus All (1/sec per machine)</button>
          </div>
          <div class="flex gap-2">
            <button id="reconnect-outside-btn" class="btn btn-accent flex-1">Reconnect Outside EOTM</button>
          </div>
          <div class="flex gap-2">
            <button id="disable-fps-btn" class="btn btn-info flex-1">Disable FPS Limiter</button>
            <button id="close-all-btn" class="btn btn-error flex-1">Close All</button>
          </div>
        </div>
      </div>

      <div class="card bg-gray-800 p-4">
        <h2 class="text-lg font-semibold mb-3">Targeted Actions</h2>
        <div class="flex flex-col gap-3">
          <div class="flex gap-2">
            <input id="close-machine-name" type="text" class="input input-bordered flex-1 bg-gray-700" placeholder="Machine name">
            <button id="close-machine-btn" class="btn btn-warning">Close Machine</button>
          </div>
          <div class="flex gap-2">
            <input id="close-server-ip" type="text" class="input input-bordered flex-1 bg-gray-700" placeholder="Server IP">
            <button id="close-server-btn" class="btn btn-warning">Close Server</button>
          </div>
          <div class="flex gap-2">
            <input id="close-character-name" type="text" class="input input-bordered flex-1 bg-gray-700" placeholder="Character name">
            <button id="close-character-btn" class="btn btn-warning">Close Character</button>
          </div>
          <div class="flex gap-2">
            <input id="ws-url" type="text" class="input input-bordered flex-1 bg-gray-700" placeholder="Override WebSocket URL">
            <button id="apply-ws-url" class="btn">Apply</button>
          </div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="card bg-gray-800 p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Instances</h2>
          <button id="refresh-btn" class="btn btn-sm">Refresh</button>
        </div>
        <div id="instances-list" class="space-y-3"></div>
      </div>

      <div class="card bg-gray-800 p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Machines</h2>
          <span class="text-xs text-gray-400">Click actions for quick close</span>
        </div>
        <div id="machines-list" class="space-y-3"></div>
      </div>
    </div>

    <div class="card bg-gray-800 p-4 mt-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Outside EOTM</h2>
        <span class="text-xs text-gray-400">Clients without an active instance</span>
      </div>
      <div id="outside-list" class="space-y-3"></div>
    </div>
  </div>

  <script>
    let ws;
    let wsUrl = buildDefaultWsUrl();
    let reconnectTimer = null;
    let statusTimer = null;
    let reconnectAttempts = 0;
    const pendingButtons = new Set();

    const connectionStatus = document.getElementById('connection-status');
    const totalClients = document.getElementById('total-clients');
    const totalInstances = document.getElementById('total-instances');
    const totalMachines = document.getElementById('total-machines');
    const instancesList = document.getElementById('instances-list');
    const machinesList = document.getElementById('machines-list');
    const outsideList = document.getElementById('outside-list');

    function buildDefaultWsUrl() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      return `${protocol}//${location.host}/eotm/admin`;
    }

    function setStatusBadge(connected) {
      connectionStatus.textContent = connected ? 'Connected' : 'Disconnected';
      connectionStatus.className = connected ? 'badge badge-success' : 'badge badge-error';
    }

    function connect() {
      if (ws && ws.readyState === WebSocket.OPEN) return;
      setStatusBadge(false);
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        setStatusBadge(true);
        reconnectAttempts = 0;
        sendMessage({ type: 'request_status' });
      };

      ws.onclose = () => {
        setStatusBadge(false);
        scheduleReconnect();
      };

      ws.onerror = () => {
        setStatusBadge(false);
      };

      ws.onmessage = (event) => {
        let message;
        try {
          message = JSON.parse(event.data);
        } catch (err) {
          return;
        }

        if (message.type === 'status') {
          renderStatus(message);
          clearPendingButtons();
        }
      };
    }

    function scheduleReconnect() {
      if (reconnectTimer) return;
      const delay = Math.min(10000, 1000 * Math.pow(1.6, reconnectAttempts));
      reconnectAttempts += 1;
      reconnectTimer = setTimeout(() => {
        reconnectTimer = null;
        connect();
      }, delay);
    }

    function startStatusPolling() {
      if (statusTimer) return;
      statusTimer = setInterval(() => {
        sendMessage({ type: 'request_status' });
      }, 5000);
    }

    function stopStatusPolling() {
      if (!statusTimer) return;
      clearInterval(statusTimer);
      statusTimer = null;
    }

    function setButtonPending(button, key, duration = 800) {
      if (!button) return;
      const pendingKey = key || button.id || button.textContent;
      if (pendingButtons.has(pendingKey)) return;
      pendingButtons.add(pendingKey);
      button.disabled = true;
      button.classList.add('loading');
      setTimeout(() => {
        button.disabled = false;
        button.classList.remove('loading');
        pendingButtons.delete(pendingKey);
      }, duration);
    }

    function clearPendingButtons() {
      document.querySelectorAll('button.loading').forEach((button) => {
        button.classList.remove('loading');
        button.disabled = false;
      });
      pendingButtons.clear();
    }

    function sendMessage(message) {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify(message));
    }

    function renderStatus(status) {
      const instances = status.instances || {};
      const machines = status.machines || {};
      const outside = status.outside || [];

      totalClients.textContent = status.total_clients || 0;
      totalInstances.textContent = Object.keys(instances).length;
      totalMachines.textContent = Object.keys(machines).length;

      instancesList.innerHTML = '';
      Object.entries(instances).forEach(([serverIp, clients]) => {
        const container = document.createElement('div');
        container.className = 'bg-gray-700 rounded p-3';

        const header = document.createElement('div');
        header.className = 'flex items-center justify-between gap-2 mb-2';
        header.innerHTML = `<div><span class="font-semibold mono">${serverIp}</span> <span class="text-xs text-gray-300">(${clients.length})</span></div>`;

        const closeBtn = document.createElement('button');
        closeBtn.className = 'btn btn-xs btn-warning';
        closeBtn.textContent = 'Close Server';
        closeBtn.addEventListener('click', () => sendMessage({ type: 'close_server', server_ip: serverIp }));

        header.appendChild(closeBtn);
        container.appendChild(header);

        const list = document.createElement('div');
        list.className = 'space-y-1 text-sm';
        clients.forEach(client => {
          const row = document.createElement('div');
          row.className = 'flex items-center justify-between bg-gray-800 rounded px-2 py-1';
          const accountLabel = client.account ? ` <span class="text-xs text-gray-400">(${client.account})</span>` : '';
          row.innerHTML = `<div>${client.character}${accountLabel} <span class="text-xs text-gray-400">@ ${client.machine}</span></div>`;

          const closeChar = document.createElement('button');
          closeChar.className = 'btn btn-xs btn-outline btn-error';
          closeChar.textContent = 'Close';
          closeChar.addEventListener('click', () => sendMessage({ type: 'close_character', character: client.character }));
          row.appendChild(closeChar);
          list.appendChild(row);
        });

        container.appendChild(list);
        instancesList.appendChild(container);
      });

      if (Object.keys(instances).length === 0) {
        instancesList.innerHTML = '<div class="text-sm text-gray-400">No active instances.</div>';
      }

      machinesList.innerHTML = '';
      Object.entries(machines).forEach(([machine, clients]) => {
        const container = document.createElement('div');
        container.className = 'bg-gray-700 rounded p-3';

        const header = document.createElement('div');
        header.className = 'flex items-center justify-between gap-2 mb-2';
        header.innerHTML = `<div><span class="font-semibold">${machine}</span> <span class="text-xs text-gray-300">(${clients.length})</span></div>`;

        const actionGroup = document.createElement('div');
        actionGroup.className = 'flex items-center gap-1';

        const focusBtn = document.createElement('button');
        focusBtn.className = 'btn btn-xs btn-secondary';
        focusBtn.textContent = 'Focus';
        focusBtn.addEventListener('click', () => sendMessage({ type: 'focus_machine', machine }));

        const minimizeBtn = document.createElement('button');
        minimizeBtn.className = 'btn btn-xs btn-secondary';
        minimizeBtn.textContent = 'Minimize';
        minimizeBtn.addEventListener('click', () => sendMessage({ type: 'minimize_machine', machine }));

        const closeBtn = document.createElement('button');
        closeBtn.className = 'btn btn-xs btn-warning';
        closeBtn.textContent = 'Close';
        closeBtn.addEventListener('click', () => sendMessage({ type: 'close_machine', machine }));

        actionGroup.appendChild(focusBtn);
        actionGroup.appendChild(minimizeBtn);
        actionGroup.appendChild(closeBtn);
        header.appendChild(actionGroup);
        container.appendChild(header);

        const list = document.createElement('div');
        list.className = 'space-y-1 text-sm';
        clients.forEach(client => {
          const row = document.createElement('div');
          row.className = 'flex items-center justify-between bg-gray-800 rounded px-2 py-1';
          const accountLabel = client.account ? ` <span class="text-xs text-gray-400">(${client.account})</span>` : '';
          row.innerHTML = `<div>${client.character}${accountLabel} <span class="text-xs text-gray-400">@ ${client.server_ip || 'unknown'}</span></div>`;

          const closeChar = document.createElement('button');
          closeChar.className = 'btn btn-xs btn-outline btn-error';
          closeChar.textContent = 'Close';
          closeChar.addEventListener('click', () => sendMessage({ type: 'close_character', character: client.character }));
          row.appendChild(closeChar);
          list.appendChild(row);
        });

        container.appendChild(list);
        machinesList.appendChild(container);
      });

      if (Object.keys(machines).length === 0) {
        machinesList.innerHTML = '<div class="text-sm text-gray-400">No active machines.</div>';
      }

      outsideList.innerHTML = '';
      if (outside.length === 0) {
        outsideList.innerHTML = '<div class="text-sm text-gray-400">All clients are currently in EOTM.</div>';
      } else {
        outside.forEach(client => {
          const container = document.createElement('div');
          container.className = 'bg-gray-700 rounded p-3';

          const accountLabel = client.account ? ` <span class="text-xs text-gray-400">(${client.account})</span>` : '';
          const reasonLabel = client.leave_reason ? ` <span class="text-xs text-gray-400">Reason: ${client.leave_reason}</span>` : '';
          const lastServer = client.last_server_ip ? ` <span class="text-xs text-gray-400">Last: ${client.last_server_ip}</span>` : '';
          const reconnectStatus = client.reconnect_status ? ` <span class="text-xs text-gray-400">Status: ${client.reconnect_status}${client.reconnect_reason ? ` (${client.reconnect_reason})` : ''}</span>` : '';

          const header = document.createElement('div');
          header.className = 'flex items-center justify-between gap-2';
          header.innerHTML = `<div>${client.character}${accountLabel} <span class="text-xs text-gray-400">@ ${client.machine}</span>${lastServer}${reasonLabel}${reconnectStatus}</div>`;

          const reconnectBtn = document.createElement('button');
          reconnectBtn.className = 'btn btn-xs btn-accent';
          reconnectBtn.textContent = 'Reconnect';
          const shouldDisable = client.reconnect_status === 'reconnect_started';
          if (shouldDisable) {
            reconnectBtn.disabled = true;
            reconnectBtn.classList.add('loading');
          }
          reconnectBtn.addEventListener('click', () => {
            setButtonPending(reconnectBtn, `reconnect-${client.machine}-${client.character}-${client.account || ''}`, 1500);
            sendMessage({
              type: 'reconnect_client',
              character: client.character,
              machine: client.machine,
              account: client.account || null
            });
          });

          header.appendChild(reconnectBtn);
          container.appendChild(header);
          outsideList.appendChild(container);
        });
      }
    }

    document.getElementById('reconnect-btn').addEventListener('click', (event) => {
      setButtonPending(event.currentTarget, 'reconnect-dashboard', 800);
      connect();
    });
    document.getElementById('refresh-btn').addEventListener('click', (event) => {
      setButtonPending(event.currentTarget, 'refresh-status', 500);
      sendMessage({ type: 'request_status' });
    });

    document.getElementById('close-excess-btn').addEventListener('click', (event) => {
      setButtonPending(event.currentTarget, 'close-excess', 800);
      const keepCount = Number(document.getElementById('close-excess-count').value || 0);
      sendMessage({ type: 'close_excess', keep_count: keepCount });
    });

    document.getElementById('keep-per-machine-btn').addEventListener('click', (event) => {
      setButtonPending(event.currentTarget, 'keep-per-machine', 800);
      const keepCount = Number(document.getElementById('keep-per-machine-count').value || 0);
      sendMessage({ type: 'keep_per_machine', keep_count: keepCount });
    });

    document.getElementById('set-fps-btn').addEventListener('click', (event) => {
      setButtonPending(event.currentTarget, 'set-fps-all', 800);
      const fps = Number(document.getElementById('set-fps-value').value || 15);
      sendMessage({ type: 'set_fps_all', fps });
    });

    document.getElementById('disable-fps-btn').addEventListener('click', (event) => {
      setButtonPending(event.currentTarget, 'disable-fps', 800);
      sendMessage({ type: 'disable_fps_limiter_all' });
    });

    document.getElementById('close-all-btn').addEventListener('click', (event) => {
      setButtonPending(event.currentTarget, 'close-all', 800);
      sendMessage({ type: 'close_all' });
    });

    document.getElementById('minimize-all-btn').addEventListener('click', (event) => {
      setButtonPending(event.currentTarget, 'minimize-all', 800);
      sendMessage({ type: 'minimize_all' });
    });

    document.getElementById('focus-all-btn').addEventListener('click', (event) => {
      setButtonPending(event.currentTarget, 'focus-all', 800);
      sendMessage({ type: 'focus_all' });
    });

    document.getElementById('reconnect-outside-btn').addEventListener('click', (event) => {
      setButtonPending(event.currentTarget, 'reconnect-outside', 1200);
      sendMessage({ type: 'reconnect_all_outside' });
    });

    document.getElementById('close-machine-btn').addEventListener('click', () => {
      const machine = document.getElementById('close-machine-name').value.trim();
      if (machine) sendMessage({ type: 'close_machine', machine });
    });

    document.getElementById('close-server-btn').addEventListener('click', () => {
      const serverIp = document.getElementById('close-server-ip').value.trim();
      if (serverIp) sendMessage({ type: 'close_server', server_ip: serverIp });
    });

    document.getElementById('close-character-btn').addEventListener('click', () => {
      const character = document.getElementById('close-character-name').value.trim();
      if (character) sendMessage({ type: 'close_character', character });
    });

    document.getElementById('apply-ws-url').addEventListener('click', () => {
      const override = document.getElementById('ws-url').value.trim();
      if (override) {
        wsUrl = override;
      } else {
        wsUrl = buildDefaultWsUrl();
      }
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.close();
      }
      connect();
    });

    connect();
    startStatusPolling();
  </script>
</body>
</html>
